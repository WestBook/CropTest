<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="croppie.css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

</head>
<style type="text/css">
    #btntest, #result, #btn1
    {
        text-align: center;
    }
</style>
<body>
<script src="es6-promise.js"></script>
<script src="croppie.js"></script>
<script src="exif.js"></script>
<div class="actions">
<div id="btn1">   
    <input type="file" id="upload" accept="image/jpeg,image/png,image/jpg" value="選擇圖片文件" />    
<div class="crop"> 
<div id="upload-demo"></div>
</div> 
</div>
<div id="btntest"> 
<button type="button" class="upload-result">裁剪</button>
</div>
<div id="result"></div> 
</div>
<script type="text/javascript">
var $uploadCrop;
    $(function() {
        
        var bwidth = 500;
        var bheight = 700;
        //var bwidth = (window.innerWidth*2)/3;
        //var bheight = 800;
        //var vwidth = ((window.innerWidth*2)/3) - 10;
        console.log(window.innerWidth);
        function readFile(input) {
            var Orientation = null;
            if (input.files && input.files[0]) {
                
                EXIF.getData(input.files[0], function () {
                        Orientation = EXIF.getTag(this, 'Orientation');
                    });
                var reader = new FileReader();
                var img = new Image();
                reader.onload = function(e) {
                img.src = e.target.result;
                var picURL = e.target.result;
                
                    img.onload = function() {
                        var canvas = document.createElement("canvas");  
                        var ctx = canvas.getContext("2d");                          
                        var base64 = null;
                        if (navigator.userAgent.match(/iphone/i)) {                 
                            if(Orientation != "" && Orientation != null){ 
                                alert(Orientation);
                                switch(Orientation){
                                    case 1:
                                        rotateImg(this, Orientation, canvas);
                                        break;
                                    case 6:
                                    rotateImg(this, Orientation, canvas);  
                                    break;  
                                case 8: 
                                    rotateImg(this,Orientation,canvas);  
                                    break;  
                                case 3:
                                    rotateImg(this,Orientation,canvas);//转两次  
                                    //rotateImg(this,Orientation,canvas);  
                                    break;  
                                }         
                            }                        
                            base64 = canvas.toDataURL("image/jpeg", 0.8); 
                           
                        }
                        if(base64 != null)
                        {
                            picURL = base64;
                        }
                        $uploadCrop.croppie('bind', {
                        //url: e.target.result,
                        url: picURL,
                        points: [img.width/2.5, img.height/2.5, img.width - (img.width/2.5), img.height - (img.height/2.5)]
                        });                                             
                                                                                                                 
                    }                   
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                alert("Sorry - you're browser doesn't support the FileReader API");
            }
        }
        $uploadCrop = $('#upload-demo').croppie({
            viewport: {
                width: 427,
                height: 672
            },
            boundary: {
                width: bwidth,
                height: bheight
            }
        });
        $('#upload').on('change', function() {
            $(".crop").show();
            readFile(this);
        });
        $('.upload-result').on('click', function(ev) {
            $uploadCrop.croppie('result', {
                type: 'canvas'
                }).then(function(resp) {            
                popupResult({
                    src: resp
                });
            });
            $
        });
        function popupResult(result) {
            var html;
            if (result.html) {
                html = result.html;
            }
            if (result.src) {
                html = '<img src="' + result.src + '" />';
            }
            $("#result").html(html);
           
        }
        function rotateImg(img, Orientation, canvas){
            if (img == null)return;    
            //img的高度和宽度不能在img元素隐藏后获取，否则会出错    
            var height = img.height;    
            var width = img.width;    
            var ctx = canvas.getContext('2d');    
            switch (Orientation) {    
                case 1:    
                canvas.width = width;    
                canvas.height = height;    
                ctx.drawImage(img, 0, 0);    
                break;    
                case 3:    
                canvas.width = width;
                canvas.height = height;
                ctx.rotate(180 * Math.PI / 180);
                ctx.drawImage(img, -width, -height);   
                break;    
                case 6:    
                canvas.width = height;
                canvas.height = width;
                ctx.rotate(90 * Math.PI / 180);
                ctx.drawImage(img, 0, -height);    
                break;    
                case 8:    
                canvas.width = height;
                canvas.height = width;
                ctx.rotate(270 * Math.PI / 180);
                ctx.drawImage(img, -width, 0);  
                break;    
            }    
        }
        //$('.cr-slider-wrap').prepend('<img src="icon_zoom2.png" />');
        //$('.cr-slider-wrap').append('<img src="icon_zoom1.png" />');
        //$('.cr-slider').css("padding-bottom", "7px");
    });
    
</script>
</body>
</html>
